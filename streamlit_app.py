# app.py
import streamlit as st
import pandas as pd
from datetime import datetime
import os

# --- ملفات البيانات ---
CSV_FILE = "evaluations.csv"  # لتخزين التقييمات
USERS_FILE = "users.csv"      # لتخزين المستخدمين

# --- إعداد الصفحة ---
st.set_page_config(page_title="تقييم", layout="wide", page_icon="🚗")

# --- إعدادات الجلسة ---
if "page" not in st.session_state:
    st.session_state.page = "login"
    if "current_user" not in st.session_state:
        st.session_state.current_user = None
        if "errors_selected" not in st.session_state:
            st.session_state.errors_selected = []
            if "notes" not in st.session_state:
                st.session_state.notes = ""
                if "start_time" not in st.session_state:
                    st.session_state.start_time = None

                    # --- قائمة الأخطاء ---
                    errors_list = [
                            "باب السائق", "حزام", "افضلية", "سرعة", "ضعف مراقبة",
                                "عدم التقيد بالمسارات", "سرعة اثناء الانعطاف", "إشارة للموازي", "موقف موازي",
                                    "صدم بالموازي", "مراقبة اثناء الخروج", "استخدام كلتا القدمين", "ضعف تحكم بالمقود",
                                        "صدم ثمانية", "إشارة ٩٠ خلفي", "موقف ٩٠ خلفي", "صدم ٩٠ خلفي", "عكس سير",
                                            "فلشر للرجوع", "الرجوع للخلف", "مراقبة اثناء الرجوع", "تسارع عالي", "تباطؤ",
                                                "فرامل", "علامةقف", "صدم رصيف", "خطوط المشاة", "تجاوز اشارة", "موقف نهائي",
                                                    "صدم نهائي"
                    ]

                    # --- التأكد من وجود ملف المستخدمين ---
                    if not os.path.exists(USERS_FILE):
                        df_users = pd.DataFrame([{
                                    "Username": "hus585",
                                            "Password": "268450",
                                                    "Role": "رئيسي",
                                                            "Active": 1
                        }])
                        df_users.to_csv(USERS_FILE,index=False)

                            # --- دوال مساعدة ---
                        def load_users():
                                return pd.read_csv(USERS_FILE)

                                def save_users(df):
                                    df.to_csv(USERS_FILE, index=False)

                                    def go_home():
                                        st.session_state.page = "home"

                                        def save_report():
                                            end_time = datetime.now()
                                            report = {
                                                            "User": st.session_state.current_user,
                                                                    "Date": st.session_state.start_time.strftime("%Y-%m-%d"),
                                                                            "Start Time": st.session_state.start_time.strftime("%H:%M"),
                                                                                    "End Time": end_time.strftime("%H:%M"),
                                                                                            "Errors": ", ".join(st.session_state.errors_selected),
                                                                                                    "Notes": st.session_state.notes
                                                }
                                            if os.path.exists(CSV_FILE):
                                                            df = pd.read_csv(CSV_FILE)
                                                            df = df.append(report, ignore_index=True)

                                                            df = pd.DataFrame([report])
                                                            df.to_csv(CSV_FILE, index=False)

                                                                                    # --- صفحة تسجيل الدخول ---
                                                            if st.session_state.page == "login":
                                                                                        st.markdown("<h2 style='text-align:center;'>تسجيل الدخول</h2>", unsafe_allow_html=True)
                                                                                        username = st.text_input("اسم المستخدم")
                                                                                        password = st.text_input("كلمة المرور", type="password")
                                                                                                    
                                                                                        if st.button("تسجيل الدخول"):
                                                                                                                df_users = load_users()
                                                                                                                user_row = df_users[(df_users["Username"]==username) & (df_users["Password"]==password)]
                                                                                                                if not user_row.empty:
                                                                                                                                            if user_row.iloc[0]["Active"] == 0:
                                                                                                                                                            st.error("الحساب معطل، يرجى التواصل مع المستخدم الرئيسي لتفعيله.")

                                                                                                                                                                                        st.session_state.current_user = username
                                                                                                                                                                                                        st.session_state.user_role = user_row.iloc[0]["Role"]
                                                                                                                                                                                                                        st.session_state.page = "home"
                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                            st.error("اسم المستخدم أو كلمة المرور غير صحيحة.")

                                                                                                                                                                                                                                            # --- الصفحة الرئيسية ---
                                                                                                                                                                                                                                            elif st.session_state.page == "home":
                                                                                                                                                                                                                                                now = datetime.now()
                                                                                                                                                                                                                                                    st.markdown(f"<div style='text-align: left; font-size:12px;'>"
                                                                                                                                                                                                                                                                    f"{now.strftime('%Y-%m-%d')}<br>{now.strftime('%H:%M')}"
                                                                                                                                                                                                                                                                                    f"</div>", unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                        st.markdown("<h1 style='text-align:center;'>تقييم</h1>", unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                col1, col2 = st.columns(2)
                                                                                                                                                                                                                                                                                                    with col1:
                                                                                                                                                                                                                                                                                                            if st.session_state.user_role in ["رئيسي", "مقيم"]:
                                                                                                                                                                                                                                                                                                                        if st.button("ابدأ التقييم"):
                                                                                                                                                                                                                                                                                                                                        st.session_state.page = "errors"
                                                                                                                                                                                                                                                                                                                                                        st.session_state.start_time = datetime.now()
                                                                                                                                                                                                                                                                                                                                                                        st.session_state.errors_selected = []
                                                                                                                                                                                                                                                                                                                                                                                        st.session_state.notes = ""
                                                                                                                                                                                                                                                                                                                                                                                            with col2:
                                                                                                                                                                                                                                                                                                                                                                                                    if st.button("عرض السجل السابق"):
                                                                                                                                                                                                                                                                                                                                                                                                                st.session_state.page = "history"
                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                        # إذا المستخدم رئيسي: زر إدارة الحسابات
                                                                                                                                                                                                                                                                                                                                                                                                                            if st.session_state.user_role == "رئيسي":
                                                                                                                                                                                                                                                                                                                                                                                                                                    if st.button("إدارة المستخدمين"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                st.session_state.page = "manage_users"

                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown("<p style='font-size:10px; text-align:center;'>تصميم حسين العييري</p>", unsafe_allow_html=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                                    # --- صفحة تسجيل الأخطاء ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                    elif st.session_state.page == "errors":
                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown("<h2 style='text-align:center;'>تسجيل الأخطاء</h2>", unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                            cols = st.columns(5)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                for idx, error in enumerate(errors_list):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        col = cols[idx % 5]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if col.button(error):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if error not in st.session_state.errors_selected:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.session_state.errors_selected.append(error)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.session_state.notes = st.text_area("الملاحظات", st.session_state.notes, height=100)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if st.button("إنهاء التقييم"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            save_report()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.session_state.page = "report"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown("<p style='font-size:10px; text-align:center;'>تصميم حسين العييري</p>", unsafe_allow_html=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # --- صفحة التقرير النهائي ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif st.session_state.page == "report":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.markdown("<h2 style='text-align:center;'>التقرير النهائي</h2>", unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.write(f"تاريخ البداية: {st.session_state.start_time.strftime('%Y-%m-%d')}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.write(f"وقت البداية: {st.session_state.start_time.strftime('%H:%M')}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.write(f"وقت النهاية: {datetime.now().strftime('%H:%M')}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.write("الأخطاء:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for err in st.session_state.errors_selected:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.write(f"- {err}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.write("الملاحظات:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.write(st.session_state.notes)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if st.button("الرجوع للرئيسية"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            go_home()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.markdown("<p style='font-size:10px; text-align:center;'>تصميم حسين العييري</p>", unsafe_allow_html=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # --- صفحة السجل ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif st.session_state.page == "history":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.markdown("<h2 style='text-align:center;'>سجل التقييمات</h2>", unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if os.path.exists(CSV_FILE):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                df = pd.read_csv(CSV_FILE)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # للمستخدم المقيم: يعرض فقط تقاريره
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if st.session_state.user_role == "مقيم":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            df = df[df["User"]==st.session_state.current_user]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.dataframe(df)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            selected_idx = st.selectbox("اختر رقم التقرير لعرض التفاصيل", df.index)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if st.button("عرض التقرير"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                report = df.loc[selected_idx]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.write(f"المستخدم: {report['User']}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.write(f"تاريخ البداية: {report['Date']}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.write(f"وقت البداية: {report['Start Time']}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.write(f"وقت النهاية: {report['End Time']}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.write("الأخطاء:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for err in report['Errors'].split(", "):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.write(f"- {err}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.write("الملاحظات:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.write(report['Notes'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.write("لا توجد تقييمات محفوظة بعد.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if st.button("الرجوع للرئيسية"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        go_home()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # --- صفحة إدارة المستخدمين (رئيسي فقط) ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif st.session_state.page == "manage_users":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.markdown("<h2 style='text-align:center;'>إدارة المستخدمين</h2>", unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                df_users = load_users()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.dataframe(df_users)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.markdown("### تفعيل / تعطيل حساب")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                selected_user_idx = st.selectbox("اختر مستخدم", df_users.index)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if st.button("تفعيل الحساب"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            df_users.at[selected_user_idx, "Active"] = 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    save_users(df_users)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.success("تم تفعيل الحساب.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if st.button("تعطيل الحساب"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        df_users.at[selected_user_idx, "Active"] = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                save_users(df_users)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.success("تم تعطيل الحساب.")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.markdown("### تغيير الصلاحيات")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new_role = st.selectbox("اختر صلاحية جديدة", ["رئيسي", "مقيم", "مشاهد فقط"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if st.button("تغيير الصلاحية"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            df_users.at[selected_user_idx, "Role"] = new_role
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    save_users(df_users)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.success("تم تغيير الصلاحية.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if st.button("الرجوع للرئيسية"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            go_home()
                                                }
                        }])
                    ]
